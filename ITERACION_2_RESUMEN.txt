================================================================================
  ITERACI√ìN 2: Datos de Seguridad en Vacantes
  Fecha: 23 de enero de 2025
================================================================================

OBJETIVO:
Hacer m√°s "seria" y confiable la creaci√≥n de vacantes, a√±adiendo campos
obligatorios de empresa, obra y contacto. NO se refactoriz√≥ nada existente,
SOLO se extendi√≥ el schema, la entidad y los formularios.

================================================================================
1. NUEVAS COLUMNAS EN LA BASE DE DATOS (tabla: job_postings)
================================================================================

ALTER TABLE public.job_postings
    ADD COLUMN IF NOT EXISTS company_rfc TEXT,
    ADD COLUMN IF NOT EXISTS company_location TEXT,
    ADD COLUMN IF NOT EXISTS worksite_location TEXT,
    ADD COLUMN IF NOT EXISTS worksite_google_maps_url TEXT,
    ADD COLUMN IF NOT EXISTS contractor_phone_whatsapp TEXT,
    ADD COLUMN IF NOT EXISTS company_phone TEXT,
    ADD COLUMN IF NOT EXISTS start_date DATE;

Archivo: supabase/migrations/20250123000002_add_job_security_fields.sql

IMPORTANTE: Todas las columnas son NULL por defecto (backward compatible).
La aplicaci√≥n las trata como obligatorias a partir de ahora.

================================================================================
2. NUEVOS CAMPOS EN ENTIDADES Y DTOs
================================================================================

Entidad de Dominio (src/domain/entities/JobPosting.ts):
  - companyRfc: string
  - companyLocation: string
  - worksiteLocation: string
  - worksiteGoogleMapsUrl?: string  (opcional en el tipo)
  - contractorPhoneWhatsapp: string
  - companyPhone: string
  - startDate: Date

DTOs de Aplicaci√≥n (src/application/dto/CreateJobPostingDTO.ts):
  CreateJobPostingDTO:
    - companyRfc: string
    - companyLocation: string
    - worksiteLocation: string
    - worksiteGoogleMapsUrl?: string
    - contractorPhoneWhatsapp: string
    - companyPhone: string
    - startDate: Date

  UpdateJobPostingDTO (todos opcionales):
    - companyRfc?: string
    - companyLocation?: string
    - worksiteLocation?: string
    - worksiteGoogleMapsUrl?: string
    - contractorPhoneWhatsapp?: string
    - companyPhone?: string
    - startDate?: Date

================================================================================
3. VALIDACIONES IMPLEMENTADAS
================================================================================

A) EN LOS CASOS DE USO (backend)
   Archivo: src/application/use-cases/recruiter/CreateJobPosting.ts
   Archivo: src/application/use-cases/recruiter/UpdateJobPosting.ts

   RFC de la Empresa (companyRfc):
     - No puede estar vac√≠o
     - Longitud: exactamente 12 o 13 caracteres
     - Error: "El RFC de la empresa debe tener 12 o 13 caracteres"

   Ubicaci√≥n de la Empresa (companyLocation):
     - No puede estar vac√≠a
     - Error: "La ubicaci√≥n de la empresa es obligatoria"

   Ubicaci√≥n de la Obra (worksiteLocation):
     - No puede estar vac√≠a
     - Error: "La ubicaci√≥n de la obra/sitio es obligatoria"

   Link Google Maps (worksiteGoogleMapsUrl):
     - Obligatorio SI modality !== 'remote'
     - Debe contener "google.com/maps" O "maps.app.goo.gl"
     - Error (si vac√≠o): "El link de Google Maps es obligatorio para trabajos que no son remotos"
     - Error (formato): "El link de Google Maps debe ser una URL v√°lida de Google Maps"
     - Opcional si modality === 'remote'

   WhatsApp del Contratista (contractorPhoneWhatsapp):
     - No puede estar vac√≠o
     - Longitud m√≠nima: 8 caracteres
     - Error: "El tel√©fono/WhatsApp del contratista debe tener al menos 8 caracteres"

   Tel√©fono de la Empresa (companyPhone):
     - No puede estar vac√≠o
     - Longitud m√≠nima: 8 caracteres
     - Error: "El tel√©fono de la empresa debe tener al menos 8 caracteres"

   Fecha de Inicio (startDate):
     - Debe ser una instancia v√°lida de Date
     - Error: "La fecha de inicio de actividades es obligatoria"

B) EN EL FRONTEND (UI)
   Archivos: src/app/recruiter/jobs/new/page.tsx
             src/app/recruiter/jobs/[id]/edit/page.tsx

   - Todos los campos marcados con required en HTML5
   - RFC: maxLength={13}, transformaci√≥n autom√°tica a may√∫sculas
   - Tel√©fonos: required
   - Fecha: input type="date" con min={today} (no permite fechas pasadas)
   - Checkbox "La obra est√° en la misma ubicaci√≥n que la empresa"
     ‚Üí copia autom√°ticamente companyLocation ‚Üí worksiteLocation
   - Link Google Maps: muestra "(opcional)" si modality === 'Remoto'

================================================================================
4. CAMBIOS EN FORMULARIOS
================================================================================

Formulario de Creaci√≥n (src/app/recruiter/jobs/new/page.tsx):
  - Agregada secci√≥n "üìã Datos de Seguridad de la Vacante"
  - Insertada ANTES de la secci√≥n de contacto
  - Campos nuevos (en orden de aparici√≥n):
    1. RFC de la Empresa* (text, maxLength 13, uppercase)
    2. Tel√©fono de la Empresa* (tel, required)
    3. Ubicaci√≥n de la Empresa* (text, required)
    4. Ubicaci√≥n de la Obra/Sitio* (text, required)
    5. ‚òë La obra est√° en la misma ubicaci√≥n que la empresa (checkbox)
    6. Link Google Maps* (url, condicional seg√∫n modalidad)
    7. WhatsApp del Contratante* (tel, required)
    8. Fecha de Inicio de Actividades* (date, min=today)

  - Texto explicativo incluido en la secci√≥n:
    "Estos datos ayudan a construir confianza con los candidatos."

  - L√≥gica del checkbox:
    Al marcar, copia valor de "Ubicaci√≥n de la Empresa" ‚Üí "Ubicaci√≥n de la Obra"
    Al desmarcar, limpia "Ubicaci√≥n de la Obra"

  - Helper text para Google Maps:
    "El link es opcional solo para vacantes completamente remotas.
     Para h√≠brido y presencial es obligatorio."

Formulario de Edici√≥n (src/app/recruiter/jobs/[id]/edit/page.tsx):
  - ID√âNTICO al formulario de creaci√≥n
  - Carga valores existentes de la vacante (fetchJob actualizado)
  - Conversi√≥n de fecha: Date ‚Üí string ISO para el input
  - Mismo comportamiento de checkbox y condicionales

================================================================================
5. CAMBIOS EN COMPONENTE DE TARJETA (JobCard)
================================================================================

Archivo: src/components/jobs/JobCard.tsx

CAMBIOS REALIZADOS:

1) Badge de RFC:
   - Si job.companyRfc existe, muestra badge verde:
     "‚úì RFC registrado"
   - Estilo: fondo verde claro, borde verde, texto verde oscuro
   - Ubicado junto a badges de √°rea laboral y "Presencial"

2) Ubicaci√≥n:
   - PRIORIDAD a worksiteLocation sobre location:
     Muestra: {job.worksiteLocation || job.location}
   - Si companyLocation existe Y difiere de worksiteLocation:
     Muestra l√≠nea adicional peque√±a:
     "Empresa: {job.companyLocation}"
   - Estilo: texto secundario (text-xs text-neutral-500)

3) Dise√±o:
   - NO se satur√≥ la tarjeta
   - Se mantuvo escaneable y limpia
   - Informaci√≥n adicional solo cuando es relevante (RFC presente, ubicaciones diferentes)

================================================================================
6. MAPEO EN REPOSITORIO
================================================================================

Archivo: src/infrastructure/supabase/SupabaseJobPostingRepository.ts

CAMBIOS:

1) mapToEntity():
   - Lee 7 campos en snake_case de la BD
   - Convierte a camelCase para la entidad
   - Valores por defecto para backward compatibility:
     ‚Üí company_rfc || '' 
     ‚Üí company_location || ''
     ‚Üí worksite_location || ''
     ‚Üí worksite_google_maps_url || ''
     ‚Üí contractor_phone_whatsapp || ''
     ‚Üí company_phone || ''
     ‚Üí start_date ? new Date(start_date) : new Date()

2) create():
   - INSERT incluye 7 nuevos campos (snake_case)
   - Mapea desde CreateJobPostingParams (camelCase)

3) update():
   - UPDATE condicional para cada campo nuevo
   - Solo actualiza si params.field !== undefined
   - 7 mapeos: companyRfc ‚Üí company_rfc, etc.

================================================================================
7. GU√çA R√ÅPIDA DE PRUEBA MANUAL
================================================================================

PASO 1: EJECUTAR MIGRACI√ìN EN SUPABASE
  1. Ir a: https://supabase.com/dashboard/project/fvqaczvjimslzupfrjrm/sql/new
  2. Pegar contenido de: supabase/migrations/20250123000002_add_job_security_fields.sql
  3. Ejecutar (RUN)
  4. Verificar: SELECT company_rfc, start_date FROM job_postings LIMIT 1;
     (las columnas deben existir)

PASO 2: PROBAR LOCALMENTE - VACANTE PRESENCIAL/H√çBRIDA
  1. Ir a: http://localhost:3000/recruiter/jobs/new
  2. Llenar todos los campos b√°sicos (t√≠tulo, descripci√≥n, etc.)
  3. En secci√≥n "Datos de Seguridad de la Vacante":
     - RFC de la Empresa: ABCD120101ABC (12 o 13 caracteres)
     - Tel√©fono de la Empresa: 5512345678
     - Ubicaci√≥n de la Empresa: CDMX, M√©xico
     - Ubicaci√≥n de la Obra: Monterrey, NL
     - Link Google Maps: https://maps.google.com/maps?q=monterrey (OBLIGATORIO)
     - WhatsApp del Contratante: 5587654321
     - Fecha de Inicio: seleccionar fecha futura
  4. Publicar vacante
  5. Verificar:
     - Creaci√≥n exitosa sin errores
     - En la tarjeta de la vacante se muestra:
       ‚Üí Badge verde "‚úì RFC registrado"
       ‚Üí Ubicaci√≥n principal: "Monterrey, NL"
       ‚Üí L√≠nea secundaria: "Empresa: CDMX, M√©xico"

PASO 3: PROBAR LOCALMENTE - VACANTE REMOTA
  1. Crear nueva vacante
  2. Seleccionar Modalidad: "Remoto"
  3. Llenar secci√≥n "Datos de Seguridad":
     - Todos los campos excepto Link Google Maps
     - Nota: El campo Google Maps debe mostrar "(opcional)"
  4. Dejar Google Maps vac√≠o
  5. Publicar vacante
  6. Verificar:
     - Creaci√≥n exitosa SIN requerir Google Maps
     - Badge RFC presente
     - Ubicaci√≥n mostrada correctamente

PASO 4: PROBAR CHECKBOX DE UBICACI√ìN
  1. Crear nueva vacante
  2. Llenar "Ubicaci√≥n de la Empresa": CDMX
  3. Marcar checkbox "La obra est√° en la misma ubicaci√≥n que la empresa"
  4. Verificar:
     - Campo "Ubicaci√≥n de la Obra" se llena autom√°ticamente con "CDMX"
  5. Desmarcar checkbox
  6. Verificar:
     - Campo "Ubicaci√≥n de la Obra" se limpia

PASO 5: PROBAR VALIDACIONES
  1. Intentar crear vacante presencial SIN Google Maps ‚Üí Error esperado
  2. Intentar RFC con 10 caracteres ‚Üí Error de validaci√≥n (m√≠nimo 12)
  3. Intentar tel√©fono con 5 caracteres ‚Üí Error de validaci√≥n (m√≠nimo 8)
  4. Verificar que NO se puede seleccionar fecha pasada en "Fecha de Inicio"

PASO 6: EDITAR VACANTE EXISTENTE
  1. Ir a editar una vacante reci√©n creada
  2. Verificar que todos los campos de seguridad est√°n cargados
  3. Modificar RFC, ubicaciones, o fecha
  4. Guardar cambios
  5. Verificar que se actualizan correctamente

PASO 7: DEPLOY A PRODUCCI√ìN
  1. Asegurarse de que la migraci√≥n se ejecut√≥ en Supabase producci√≥n
  2. Deploy: vercel --prod
  3. Esperar build completion
  4. Probar en producci√≥n: crear vacante con todos los campos
  5. Verificar JobCard muestra badge RFC y ubicaciones correctamente

================================================================================
8. QU√â SE VE DISTINTO AHORA EN LA TARJETA DE VACANTE
================================================================================

ANTES:
  - Solo mostraba job.location
  - No hab√≠a informaci√≥n de RFC o empresa

AHORA:
  - Muestra worksiteLocation (ubicaci√≥n de la obra) con prioridad
  - Badge verde "‚úì RFC registrado" si la empresa proporcion√≥ RFC
  - Si la empresa est√° en ubicaci√≥n diferente a la obra:
    ‚Üí L√≠nea adicional peque√±a: "Empresa: [ciudad]"
  - Dise√±o limpio, sin saturaci√≥n visual

BENEFICIOS:
  - Mayor transparencia: candidatos ven d√≥nde realmente trabajar√°n (obra)
  - Confianza: badge de RFC indica datos empresariales registrados
  - Contexto: ubicaci√≥n de empresa visible cuando difiere del sitio de trabajo

================================================================================
9. ARCHIVOS MODIFICADOS (RESUMEN)
================================================================================

BASE DE DATOS:
  ‚úÖ supabase/migrations/20250123000002_add_job_security_fields.sql (nuevo)

DOMINIO:
  ‚úÖ src/domain/entities/JobPosting.ts (extendido)

APLICACI√ìN:
  ‚úÖ src/application/dto/CreateJobPostingDTO.ts (extendido)
  ‚úÖ src/application/use-cases/recruiter/CreateJobPosting.ts (validaciones agregadas)
  ‚úÖ src/application/use-cases/recruiter/UpdateJobPosting.ts (validaciones agregadas)

INFRAESTRUCTURA:
  ‚úÖ src/infrastructure/supabase/SupabaseJobPostingRepository.ts (mapeo extendido)

PRESENTACI√ìN:
  ‚úÖ src/app/recruiter/jobs/new/page.tsx (secci√≥n "Datos de Seguridad" agregada)
  ‚úÖ src/app/recruiter/jobs/[id]/edit/page.tsx (secci√≥n "Datos de Seguridad" agregada)
  ‚úÖ src/components/jobs/JobCard.tsx (badge RFC + ubicaci√≥n dual)

TOTAL: 9 archivos modificados/creados

================================================================================
10. NOTAS IMPORTANTES
================================================================================

- NO se modific√≥ nada de Iteraci√≥n 1 (KYC, Terms & Conditions)
- NO se renombraron archivos ni carpetas existentes
- SOLO se agregaron campos y validaciones sobre lo que ya funcionaba
- Arquitectura hexagonal respetada: validaciones en capa de aplicaci√≥n
- Backward compatible: vacantes viejas sin estos campos siguen funcionando
- DTOs separados de entidades: capa de aplicaci√≥n limpia
- Formularios id√©nticos en create y edit: consistencia UX

================================================================================
FIN DEL RESUMEN - ITERACI√ìN 2
================================================================================
