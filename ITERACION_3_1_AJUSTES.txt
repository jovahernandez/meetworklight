================================================================================
  ITERACI√ìN 3.1: Ajustes de Vigencia y Correcciones
  Fecha: 23 de enero de 2025
================================================================================

OBJETIVO:
Corregir detalles de la Iteraci√≥n 3 (vigencia de vacantes) sin refactorizar.
Espec√≠ficamente:
1. Usar is_active (BOOLEAN) en lugar de status.
2. Manejar correctamente expiresAt como null para vacantes viejas.
3. No inventar fechas de expiraci√≥n para vacantes sin expires_at en BD.

NO se movieron carpetas, NO se renombraron archivos, NO se toc√≥ KYC/Terms/Seguridad.
SOLO se corrigieron los filtros y el manejo de null en vigencia.

================================================================================
1. CONFIRMACI√ìN: USO DE is_active EN LUGAR DE status
================================================================================

PROBLEMA CORREGIDO:
- La Iteraci√≥n 3 mencionaba filtros tipo `status = 'active'`.
- El schema real usa `is_active BOOLEAN`, no una columna status.

CAMBIOS REALIZADOS:

A) En SupabaseJobPostingRepository.findAll():

ANTES (incorrecto):
```typescript
if (filters?.isActive !== undefined) {
    query = query.eq('status', filters.isActive ? 'active' : 'inactive');
} else {
    query = query.eq('status', 'active');
}
```

AHORA (correcto):
```typescript
// Iteraci√≥n 3.1: Usar is_active (BOOLEAN) en lugar de status
if (filters?.isActive !== undefined) {
    query = query.eq('is_active', filters.isActive);
} else {
    // By default, only show active jobs
    query = query.eq('is_active', true);
}

// Iteraci√≥n 3.1: Filtrar vacantes expiradas (solo para buscadores)
const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
query = query.or(`expires_at.is.null,expires_at.gte.${today}`);
```

B) En SupabaseJobPostingRepository.mapToEntity():

ANTES (incorrecto):
```typescript
isActive: data.status === 'active',
```

AHORA (correcto):
```typescript
isActive: data.is_active ?? false, // Iteraci√≥n 3.1: usar is_active BOOLEAN
```

C) En SupabaseJobPostingRepository.create():

ANTES (incorrecto):
```typescript
status: 'active',
```

AHORA (correcto):
```typescript
is_active: true, // Iteraci√≥n 3.1: usar is_active BOOLEAN
```

D) En SupabaseJobPostingRepository.update():

ANTES (incorrecto):
```typescript
if (params.isActive !== undefined) updateData.status = params.isActive ? 'active' : 'inactive';
```

AHORA (correcto):
```typescript
if (params.isActive !== undefined) updateData.is_active = params.isActive;
```

RESULTADO:
- Todas las queries ahora usan `is_active = true` (BOOLEAN).
- El filtro de vigencia es: `(expires_at IS NULL OR expires_at >= hoy)`.
- NO se usa ninguna columna `status` en el flujo de vacantes.

================================================================================
2. MANEJO CORRECTO DE expiresAt PARA VACANTES VIEJAS
================================================================================

PROBLEMA CORREGIDO:
- El mapper original inventaba una fecha (today + 30 d√≠as) para vacantes sin expires_at.
- Esto ment√≠a al usuario sobre la vigencia real de vacantes viejas.

CAMBIOS REALIZADOS:

A) Tipo de JobPosting.expiresAt:

ANTES:
```typescript
export interface JobPosting {
    ...
    validityDays: number;
    expiresAt: Date;  // NO permit√≠a null
}
```

AHORA:
```typescript
export interface JobPosting {
    ...
    // Iteraci√≥n 3.1: Vigencia (expiresAt puede ser null para vacantes viejas)
    validityDays: number;
    expiresAt: Date | null;  // Permite null
}
```

B) Mapper en SupabaseJobPostingRepository.mapToEntity():

ANTES (incorrecto):
```typescript
validityDays: data.validity_days || 30,
expiresAt: data.expires_at 
    ? new Date(data.expires_at) 
    : new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // ‚ùå Inventaba fecha
```

AHORA (correcto):
```typescript
// Iteraci√≥n 3.1: Vigencia (sin inventar fechas para vacantes viejas)
validityDays: data.validity_days || 30,
expiresAt: data.expires_at ? new Date(data.expires_at) : null, // ‚úÖ Null si no existe
```

C) Interface Job en dashboard (/recruiter/jobs/page.tsx):

ANTES:
```typescript
interface Job {
    ...
    expiresAt: string;  // NO permit√≠a null
}
```

AHORA:
```typescript
interface Job {
    ...
    // Iteraci√≥n 3.1: Vigencia (expiresAt puede ser null para vacantes viejas)
    validityDays: number;
    expiresAt: string | null;  // Permite null
}
```

D) Funci√≥n getJobStatus en dashboard:

La funci√≥n YA manejaba correctamente el caso null desde Iteraci√≥n 3:

```typescript
const getJobStatus = (job: Job) => {
    if (!job.expiresAt) return { status: 'active', daysLeft: null, message: null };
    
    // ... resto del c√°lculo para vacantes con fecha
}
```

COMPORTAMIENTO:
- Si `job.expiresAt` es null ‚Üí status: 'active', daysLeft: null, NO mensaje.
- Si `job.expiresAt` existe ‚Üí calcula daysLeft y determina estado (expired/expiring_soon/active).

RESULTADO:
- Vacantes viejas (expires_at = NULL en BD) ‚Üí se mapean con expiresAt = null.
- Dashboard NO muestra badge "X d√≠as restantes" para vacantes sin vigencia.
- Solo muestra badge "Activa/Inactiva" est√°ndar (sin inventar informaci√≥n falsa).

================================================================================
3. COMPORTAMIENTO ACTUALIZADO DEL DASHBOARD
================================================================================

VACANTES CON expiresAt = null (VACANTES VIEJAS):

En el dashboard del reclutador (/recruiter/jobs):
- Badge: Solo "Activa" (verde) o "Inactiva" (gris) seg√∫n is_active.
- NO se muestra badge de "X d√≠as restantes".
- NO se muestra mensaje de advertencia.
- Tratamiento: vacante activa sin vigencia configurada.

VACANTES CON expiresAt DEFINIDO (VACANTES NUEVAS):

Estado "expired" (daysLeft < 0):
- Badge adicional: üî¥ Expirada (rojo)
- Mensaje: "Esta vacante ya no se muestra a los candidatos"
- Fondo rojo claro debajo del t√≠tulo

Estado "expiring_soon" (0 <= daysLeft <= 3):
- Badge adicional: ‚ö†Ô∏è Por expirar (naranja)
- Mensaje: "Tu vacante expira en X d√≠as. Actual√≠zala o se desactivar√°"
- Fondo naranja claro debajo del t√≠tulo

Estado "active" (daysLeft > 3):
- Badge adicional: üìÖ X d√≠as restantes (azul)
- NO mensaje de advertencia

IMPORTANTE:
- El badge "Activa/Inactiva" siempre se muestra (basado en is_active).
- Los badges de vigencia (üî¥/‚ö†Ô∏è/üìÖ) son adicionales y SOLO para vacantes con expiresAt definido.

================================================================================
4. FILTRADO DE VACANTES PARA BUSCADORES
================================================================================

Query en SupabaseJobPostingRepository.findAll():

```sql
WHERE is_active = true
  AND (expires_at IS NULL OR expires_at >= CURRENT_DATE)
```

Equivalente en Supabase JS:

```typescript
query = query.eq('is_active', true);
const today = new Date().toISOString().split('T')[0];
query = query.or(`expires_at.is.null,expires_at.gte.${today}`);
```

COMPORTAMIENTO:

Caso A: Vacante vieja (expires_at = NULL)
- Condici√≥n: is_active = true AND expires_at IS NULL
- Resultado: ‚úÖ SE MUESTRA a candidatos
- Explicaci√≥n: Vacantes viejas siguen visibles hasta que se editen

Caso B: Vacante nueva vigente (expires_at >= hoy)
- Condici√≥n: is_active = true AND expires_at >= hoy
- Resultado: ‚úÖ SE MUESTRA a candidatos
- Explicaci√≥n: Vacante a√∫n no ha expirado

Caso C: Vacante expirada (expires_at < hoy)
- Condici√≥n: is_active = true BUT expires_at < hoy
- Resultado: ‚ùå NO SE MUESTRA a candidatos
- Explicaci√≥n: Vacante venci√≥, desaparece autom√°ticamente de b√∫squeda

Caso D: Vacante inactiva (is_active = false)
- Condici√≥n: is_active = false
- Resultado: ‚ùå NO SE MUESTRA a candidatos
- Explicaci√≥n: Reclutador la desactiv√≥ manualmente

================================================================================
5. C√ÅLCULO DE expiresAt (SIN CAMBIOS EN LA F√ìRMULA)
================================================================================

NO se modific√≥ la l√≥gica de c√°lculo de expiresAt en los casos de uso.

En CreateJobPosting:
```typescript
const today = new Date();
today.setHours(0, 0, 0, 0);
const expiresAt = new Date(today.getTime() + (validityDays * 24 * 60 * 60 * 1000));
```

En UpdateJobPosting:
```typescript
if (dto.validityDays !== undefined) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    expiresAt = new Date(today.getTime() + (validityDays * 24 * 60 * 60 * 1000));
}
```

NOTA:
- La f√≥rmula actual calcula: hoy + X d√≠as completos.
- NO se ajust√≥ para posibles "off-by-one" (como solicitado en instrucciones).
- Se mantiene exactamente igual que en Iteraci√≥n 3.

================================================================================
6. GU√çA DE PRUEBA MANUAL
================================================================================

CASO A: VACANTE VIEJA SIN expires_at (NULL EN BD)

1. En Supabase SQL Editor:
   ```sql
   INSERT INTO job_postings (
       recruiter_id, title, company_name, location, industrial_sector,
       job_area, contract_type, modality, shift, description_short,
       contact_phone, contact_email, is_active,
       company_rfc, company_location, worksite_location,
       contractor_phone_whatsapp, company_phone, start_date
   ) VALUES (
       'xxx', 'Maestro de Obra (Vacante Vieja)', 'Constructora ABC',
       'CDMX', 'Construcci√≥n', 'Alba√±iler√≠a', 'full-time', 'on-site',
       'morning', 'Vacante de prueba sin vigencia', '5512345678',
       'rh@abc.com', true,
       'ABC120101ABC', 'CDMX', 'CDMX', '5587654321', '5512345678',
       CURRENT_DATE
   );
   -- Nota: NO se especifican validity_days ni expires_at (quedan NULL)
   ```

2. Ir a b√∫squeda de vacantes (/jobs):
   - ‚úÖ La vacante SE MUESTRA en resultados.

3. Dashboard del reclutador (/recruiter/jobs):
   - Badge: "Activa" (verde).
   - NO aparece badge "X d√≠as restantes".
   - NO aparece mensaje de advertencia.

4. Editar la vacante:
   - Slider aparece en 30 d√≠as (default).
   - Al guardar ‚Üí ahora tiene validity_days=30 y expires_at calculado.

CASO B: VACANTE NUEVA CON expires_at DEFINIDO

1. Crear vacante desde /recruiter/jobs/new:
   - Llenar todos los campos.
   - Slider de vigencia: mover a 15 d√≠as.
   - Publicar.

2. Dashboard del reclutador:
   - Badge: "Activa" (verde).
   - Badge adicional: "üìÖ 15 d√≠as restantes" (azul, aprox).
   - NO mensaje de advertencia (tiene > 3 d√≠as).

3. B√∫squeda (/jobs):
   - ‚úÖ La vacante SE MUESTRA.

CASO C: VACANTE POR EXPIRAR (0-3 D√çAS RESTANTES)

1. En Supabase SQL Editor:
   ```sql
   UPDATE job_postings 
   SET expires_at = CURRENT_DATE + INTERVAL '2 days',
       validity_days = 2
   WHERE id = 'xxx';
   ```

2. Dashboard del reclutador:
   - Badge: "Activa" (verde).
   - Badge adicional: "‚ö†Ô∏è Por expirar" (naranja).
   - Mensaje naranja: "Tu vacante expira en 2 d√≠as. Actual√≠zala o se desactivar√°".

3. B√∫squeda (/jobs):
   - ‚úÖ La vacante SE MUESTRA (a√∫n no expir√≥).

CASO D: VACANTE EXPIRADA (expiresAt < hoy)

1. En Supabase SQL Editor:
   ```sql
   UPDATE job_postings 
   SET expires_at = CURRENT_DATE - INTERVAL '1 day',
       validity_days = 7
   WHERE id = 'xxx';
   ```

2. Dashboard del reclutador:
   - Badge: "Activa" (verde, porque is_active sigue en true).
   - Badge adicional: "üî¥ Expirada" (rojo).
   - Mensaje rojo: "Esta vacante ya no se muestra a los candidatos".

3. B√∫squeda (/jobs):
   - ‚ùå La vacante NO SE MUESTRA.
   - Filtro: `expires_at < hoy` ‚Üí excluida autom√°ticamente.

4. Reclutador puede:
   - Editar la vacante.
   - Cambiar vigencia a 7-30 d√≠as nuevos.
   - Guardar ‚Üí expires_at se recalcula desde HOY.
   - Vacante vuelve a aparecer en b√∫squeda.

CASO E: VERIFICAR is_active vs status

1. En Supabase SQL Editor:
   ```sql
   SELECT id, title, is_active, expires_at FROM job_postings LIMIT 5;
   ```

2. Confirmar:
   - Columna `is_active` existe y es BOOLEAN (true/false).
   - NO debe existir columna `status` (si existe, es legacy).

3. Activar/Desactivar vacante desde UI:
   - El toggle debe actualizar `is_active` directamente.

4. Verificar query logs (consola navegador):
   - Debe mostrar: "Filtering by is_active = true".
   - NO debe mostrar: "Filtering by status = active".

================================================================================
7. ARCHIVOS MODIFICADOS (RESUMEN)
================================================================================

DOMINIO:
  ‚úÖ src/domain/entities/JobPosting.ts
     - Cambio: expiresAt: Date | null (permite null)
     - Agregados: validityDays, expiresAt (si faltaban)

APLICACI√ìN:
  ‚úÖ src/application/dto/CreateJobPostingDTO.ts
     - Agregado: validityDays: number (si faltaba)
  
  ‚úÖ src/application/use-cases/recruiter/CreateJobPosting.ts
     - Agregada: validaci√≥n validityDays (7-30)
     - Agregado: c√°lculo expiresAt (si faltaba)
  
  ‚úÖ src/application/use-cases/recruiter/UpdateJobPosting.ts
     - Agregada: validaci√≥n validityDays (si faltaba)
     - Agregado: rec√°lculo expiresAt (si faltaba)

INFRAESTRUCTURA:
  ‚úÖ src/infrastructure/supabase/SupabaseJobPostingRepository.ts
     - findAll(): cambio status ‚Üí is_active, agregado filtro expires_at
     - mapToEntity(): cambio status ‚Üí is_active, expiresAt null en lugar de fecha inventada
     - create(): cambio status ‚Üí is_active, agregados validity_days/expires_at
     - update(): cambio status ‚Üí is_active, agregados validity_days/expires_at

PRESENTACI√ìN:
  ‚úÖ src/app/recruiter/jobs/page.tsx
     - Interface Job: expiresAt: string | null (permite null)
     - getJobStatus: ya manejaba null correctamente (sin cambios)

TOTAL: 7 archivos modificados

================================================================================
8. DIFERENCIAS CON ITERACI√ìN 3 ORIGINAL
================================================================================

CAMBIO 1: Columna de estado
- Iteraci√≥n 3: usaba `status` (texto 'active'/'inactive')
- Iteraci√≥n 3.1: usa `is_active` (BOOLEAN true/false) ‚úÖ

CAMBIO 2: Manejo de vacantes viejas
- Iteraci√≥n 3: inventaba expiresAt = hoy + 30 d√≠as si NULL
- Iteraci√≥n 3.1: deja expiresAt = null si NULL en BD ‚úÖ

CAMBIO 3: Tipo de expiresAt
- Iteraci√≥n 3: expiresAt: Date (NO null)
- Iteraci√≥n 3.1: expiresAt: Date | null ‚úÖ

MANTENIDO SIN CAMBIOS:
- ‚úÖ F√≥rmula de c√°lculo de expiresAt (hoy + validityDays d√≠as)
- ‚úÖ Validaci√≥n 7-30 d√≠as
- ‚úÖ L√≥gica de estados (expired/expiring_soon/active)
- ‚úÖ UI del slider en formularios
- ‚úÖ Badges visuales en dashboard
- ‚úÖ Filtro para buscadores (solo se corrigi√≥ sintaxis is_active)

================================================================================
9. NOTAS FINALES
================================================================================

- NO se modific√≥ nada de Iteraci√≥n 1 (KYC) ni Iteraci√≥n 2 (Seguridad).
- NO se crearon nuevas migraciones (solo se usan las de Iteraci√≥n 3).
- NO se cambi√≥ la f√≥rmula de c√°lculo de d√≠as (posibles off-by-one mantienen).
- Arquitectura hexagonal respetada: correcciones solo en capas correspondientes.
- Backward compatible: vacantes viejas siguen funcionando.
- Frontend forms (new/edit) ya ten√≠an validityDays desde Iteraci√≥n 3 (no se tocaron).

PR√ìXIMOS PASOS (SI APLICAN):
1. Ejecutar migraci√≥n de Iteraci√≥n 3 en Supabase (si no se hizo):
   supabase/migrations/20250123000003_add_job_validity_fields.sql

2. Verificar que la columna `is_active` existe en job_postings.
   - Si existe columna `status` (texto), podr√≠a causar confusi√≥n.
   - Considerar eliminar `status` en una futura limpieza (opcional).

3. Deploy a producci√≥n y probar casos A-E de esta gu√≠a.

================================================================================
FIN DEL RESUMEN - ITERACI√ìN 3.1
================================================================================
