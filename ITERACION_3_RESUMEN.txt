================================================================================
  ITERACI√ìN 3: Vigencia y Urgencia de Vacantes
  Fecha: 23 de enero de 2025
================================================================================

OBJETIVO:
Dar vigencia real a las vacantes con un ciclo de vida de 7-30 d√≠as. El reclutador
elige la duraci√≥n mediante un slider, se calcula autom√°ticamente la fecha de
expiraci√≥n, las vacantes vencidas se ocultan para buscadores, y el reclutador
recibe avisos visuales cuando sus vacantes est√°n por expirar.

NO se refactoriz√≥ nada. SOLO se extendi√≥: schema, entidad, DTOs, casos de uso,
repositorio, formularios y dashboard del reclutador.

================================================================================
1. NUEVAS COLUMNAS EN LA BASE DE DATOS (tabla: job_postings)
================================================================================

ALTER TABLE public.job_postings
    ADD COLUMN IF NOT EXISTS validity_days INTEGER,
    ADD COLUMN IF NOT EXISTS expires_at DATE;

Archivo: supabase/migrations/20250123000003_add_job_validity_fields.sql

COMPORTAMIENTO:
- Ambas columnas NULL por defecto (backward compatible con vacantes viejas).
- Vacantes NUEVAS (creadas despu√©s de esta iteraci√≥n):
  - validity_days: siempre entre 7 y 30 (validado en backend).
  - expires_at: calculada autom√°ticamente como (fecha actual + validity_days).
- Vacantes VIEJAS (anteriores a esta iteraci√≥n):
  - expires_at = NULL ‚Üí se siguen mostrando como activas hasta que se editen.
  - Al editar y elegir vigencia ‚Üí entran al nuevo flujo.

================================================================================
2. NUEVOS CAMPOS EN ENTIDADES Y DTOs
================================================================================

Entidad de Dominio (src/domain/entities/JobPosting.ts):
  - validityDays: number;  // 7-30 d√≠as
  - expiresAt: Date;       // Fecha de expiraci√≥n calculada

DTOs de Aplicaci√≥n (src/application/dto/CreateJobPostingDTO.ts):
  CreateJobPostingDTO:
    - validityDays: number;  // requerido, viene del slider

  UpdateJobPostingDTO:
    - validityDays?: number; // opcional, si viene ‚Üí recalcula expiresAt

IMPORTANTE:
- El frontend NO env√≠a expiresAt directamente.
- El frontend SOLO env√≠a validityDays desde el slider.
- El backend (casos de uso) calcula expiresAt usando la fecha actual del servidor.

================================================================================
3. VALIDACIONES Y C√ÅLCULO DE EXPIRACI√ìN
================================================================================

A) VALIDACI√ìN DE validityDays

En CreateJobPosting:
  - Campo obligatorio.
  - Rango: entre 7 y 30 d√≠as (inclusive).
  - Error: "Validity must be between 7 and 30 days"

En UpdateJobPosting:
  - Si se proporciona: validar rango 7-30.
  - Si NO se proporciona: mantener expires_at existente.

B) C√ÅLCULO DE expiresAt (BACKEND AUTHORITY)

En CreateJobPosting:
  ```
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const expiresAt = new Date(today.getTime() + (validityDays * 24 * 60 * 60 * 1000));
  ```

En UpdateJobPosting:
  - Si llega validityDays:
    ```
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    expiresAt = new Date(today.getTime() + (validityDays * 24 * 60 * 60 * 1000));
    ```
  - Si NO llega validityDays: no recalcula, mantiene expires_at existente.

REGLA CLAVE:
- El backend usa su propia fecha actual (no conf√≠a en el frontend).
- Esto garantiza consistencia y previene manipulaci√≥n.

================================================================================
4. FILTRADO DE VACANTES PARA BUSCADORES
================================================================================

Caso de Uso: FilterJobPostings
Archivo: src/infrastructure/supabase/SupabaseJobPostingRepository.ts

NUEVA L√ìGICA EN findAll():
```sql
WHERE status = 'active'
  AND (expires_at IS NULL OR expires_at >= CURRENT_DATE)
```

COMPORTAMIENTO:
- Vacantes con expires_at = NULL ‚Üí se muestran (vacantes viejas).
- Vacantes con expires_at >= hoy ‚Üí se muestran (vigentes).
- Vacantes con expires_at < hoy ‚Üí NO se muestran (expiradas).

Resultado:
- Los buscadores SOLO ven vacantes activas y vigentes.
- Las vacantes expiradas desaparecen autom√°ticamente de la b√∫squeda.

================================================================================
5. C√ÅLCULO DE ESTADO Y D√çAS RESTANTES (PARA RECLUTADOR)
================================================================================

Dashboard del Reclutador (src/app/recruiter/jobs/page.tsx)

FUNCI√ìN getJobStatus(job):
```javascript
const today = new Date();
today.setHours(0, 0, 0, 0);
const expiresDate = new Date(job.expiresAt);
expiresDate.setHours(0, 0, 0, 0);

const diffTime = expiresDate.getTime() - today.getTime();
const daysLeft = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

if (daysLeft < 0) {
    return { status: 'expired', daysLeft, message: '...' };
} else if (daysLeft <= 3) {
    return { status: 'expiring_soon', daysLeft, message: '...' };
} else {
    return { status: 'active', daysLeft, message: null };
}
```

ESTADOS:
1. "expired" (daysLeft < 0):
   - Badge: üî¥ Expirada (rojo)
   - Mensaje: "Esta vacante ya no se muestra a los candidatos"

2. "expiring_soon" (0 <= daysLeft <= 3):
   - Badge: ‚ö†Ô∏è Por expirar (naranja)
   - Mensaje: "Tu vacante expira en X d√≠as. Actual√≠zala o se desactivar√°"

3. "active" (daysLeft > 3 OR expires_at IS NULL):
   - Badge: üìÖ X d√≠as restantes (azul)
   - Sin mensaje de advertencia.

================================================================================
6. CAMBIOS EN FORMULARIOS DE CREACI√ìN/EDICI√ìN
================================================================================

Archivos:
- src/app/recruiter/jobs/new/page.tsx
- src/app/recruiter/jobs/[id]/edit/page.tsx

NUEVA SECCI√ìN: "‚è± Duraci√≥n y nivel de urgencia"
Ubicaci√≥n: Despu√©s de "Datos de Seguridad", antes de campos de contacto.

CONTENIDO:

1) Slider de Vigencia:
   - Label: "Vigencia de la vacante: {X} d√≠as"
   - Input type="range", min="7", max="30", step="1"
   - Valor por defecto:
     - Crear: 30 d√≠as
     - Editar: job.validityDays (o 30 si no existe)

2) Nivel de Urgencia (calculado en frontend, solo visual):
   - 7-10 d√≠as ‚Üí üî¥ Alta (texto rojo)
   - 11-20 d√≠as ‚Üí üü° Media (texto amarillo)
   - 21-30 d√≠as ‚Üí üü¢ Baja (texto verde)

3) Fecha de Expiraci√≥n (calculada en frontend, solo vista previa):
   - "Activa hasta: [fecha formateada]"
   - Calcula: today + validityDays d√≠as
   - Formato: "23 de enero de 2025" (es-MX)

4) Tip:
   - "üí° Tip: Las vacantes con urgencia alta (7-10 d√≠as) aparecen destacadas"

VALIDACI√ìN:
- El slider es requerido (no se puede submit sin seleccionar).
- El backend valida rango 7-30 y rechaza si est√° fuera.

================================================================================
7. CAMBIOS EN DASHBOARD DEL RECLUTADOR
================================================================================

Archivo: src/app/recruiter/jobs/page.tsx

CAMBIOS VISUALES:

1) Interface Job extendida:
   - validityDays: number
   - expiresAt: string

2) Badges de Estado (junto a badge "Activa/Inactiva"):
   
   VACANTE EXPIRADA:
   - Badge rojo: "üî¥ Expirada"
   - Mensaje debajo del t√≠tulo: fondo rojo claro
     "Esta vacante ya no se muestra a los candidatos"

   VACANTE POR EXPIRAR (0-3 d√≠as):
   - Badge naranja: "‚ö†Ô∏è Por expirar"
   - Mensaje debajo del t√≠tulo: fondo naranja claro
     "Tu vacante expira en X d√≠as. Actual√≠zala o se desactivar√°"

   VACANTE ACTIVA (> 3 d√≠as):
   - Badge azul: "üìÖ X d√≠as restantes"
   - Sin mensaje de advertencia.

3) Acciones:
   - Bot√≥n "Ver Detalles" funciona igual que antes.
   - NO se bloquea la edici√≥n de vacantes expiradas.
   - El reclutador puede actualizar vigencia editando la vacante.

================================================================================
8. MAPEO EN REPOSITORIO
================================================================================

Archivo: src/infrastructure/supabase/SupabaseJobPostingRepository.ts

1) create():
   - Incluye validity_days y expires_at en INSERT.
   - Mapea desde CreateJobPostingParams (camelCase ‚Üí snake_case).

2) update():
   - Actualiza validity_days si params.validityDays !== undefined.
   - Actualiza expires_at si params.expiresAt !== undefined.

3) mapToEntity():
   - Lee validity_days y expires_at de la BD.
   - Convierte a camelCase para la entidad.
   - Defaults para backward compatibility:
     ‚Üí validityDays: data.validity_days || 30
     ‚Üí expiresAt: data.expires_at ? new Date(data.expires_at) : new Date(Date.now() + 30 * 24 * 60 * 60 * 1000)

4) findAll() - Filtro para Buscadores:
   - Agrega condici√≥n OR en query:
     `.or(\`expires_at.is.null,expires_at.gte.${today}\`)`
   - Solo muestra vacantes con expires_at = NULL O expires_at >= hoy.

================================================================================
9. GU√çA R√ÅPIDA DE PRUEBA MANUAL
================================================================================

PASO 1: EJECUTAR MIGRACI√ìN EN SUPABASE
  1. Ir a: https://supabase.com/dashboard/project/fvqaczvjimslzupfrjrm/sql/new
  2. Pegar contenido de: supabase/migrations/20250123000003_add_job_validity_fields.sql
  3. Ejecutar (RUN)
  4. Verificar: SELECT validity_days, expires_at FROM job_postings LIMIT 1;

PASO 2: CREAR VACANTE CON VIGENCIA CORTA (URGENTE)
  1. Ir a: /recruiter/jobs/new
  2. Llenar todos los campos requeridos.
  3. En secci√≥n "Duraci√≥n y nivel de urgencia":
     - Mover slider a 7 d√≠as.
     - Verificar que muestra "Nivel de urgencia: üî¥ Alta".
     - Verificar fecha de expiraci√≥n = hoy + 7 d√≠as.
  4. Publicar vacante.
  5. Verificar en dashboard:
     - Badge "üìÖ 7 d√≠as restantes" (o 6, dependiendo del tiempo transcurrido).
     - Sin mensaje de advertencia todav√≠a.

PASO 3: CREAR VACANTE CON VIGENCIA MEDIA
  1. Crear nueva vacante.
  2. Slider en 15 d√≠as.
  3. Verificar "Nivel de urgencia: üü° Media".
  4. Publicar.
  5. Dashboard muestra: "üìÖ 15 d√≠as restantes".

PASO 4: CREAR VACANTE CON VIGENCIA LARGA
  1. Crear nueva vacante.
  2. Slider en 30 d√≠as (default).
  3. Verificar "Nivel de urgencia: üü¢ Baja".
  4. Publicar.
  5. Dashboard muestra: "üìÖ 30 d√≠as restantes".

PASO 5: EDITAR VACANTE Y CAMBIAR VIGENCIA
  1. Editar una vacante existente.
  2. Cambiar slider de 30 a 10 d√≠as.
  3. Guardar cambios.
  4. Verificar:
     - expires_at se recalcula desde HOY (no desde la fecha original).
     - Dashboard actualiza el badge de d√≠as restantes.

PASO 6: SIMULAR VACANTE POR EXPIRAR
  (Nota: Requiere modificar manualmente expires_at en BD o esperar 27+ d√≠as)
  1. En Supabase SQL Editor:
     UPDATE job_postings 
     SET expires_at = CURRENT_DATE + INTERVAL '2 days'
     WHERE id = 'xxx';
  2. Ir al dashboard del reclutador.
  3. Verificar:
     - Badge naranja: "‚ö†Ô∏è Por expirar"
     - Mensaje: "Tu vacante expira en 2 d√≠as..."

PASO 7: SIMULAR VACANTE EXPIRADA
  1. En Supabase SQL Editor:
     UPDATE job_postings 
     SET expires_at = CURRENT_DATE - INTERVAL '1 day'
     WHERE id = 'xxx';
  2. Dashboard del reclutador:
     - Badge rojo: "üî¥ Expirada"
     - Mensaje: "Esta vacante ya no se muestra a los candidatos"
  3. Ir a b√∫squeda de vacantes (/jobs):
     - La vacante expirada NO aparece en resultados.

PASO 8: VERIFICAR BACKWARD COMPATIBILITY
  1. Si hay vacantes viejas (anteriores a migraci√≥n):
     - expires_at = NULL ‚Üí se muestran en b√∫squeda.
     - Dashboard muestra badge normal sin d√≠as restantes.
  2. Al editar vacante vieja:
     - Forzar a elegir vigencia con slider.
     - Guardar ‚Üí ahora tiene expires_at calculado.

PASO 9: DEPLOY A PRODUCCI√ìN
  1. Ejecutar migraci√≥n en Supabase producci√≥n.
  2. Deploy: vercel --prod
  3. Probar en producci√≥n:
     - Crear vacante con 7 d√≠as ‚Üí verificar badge urgencia alta.
     - Verificar filtrado de vacantes expiradas en b√∫squeda.
     - Verificar dashboard muestra avisos correctamente.

================================================================================
10. QU√â SE VE NUEVO EN EL SISTEMA
================================================================================

FORMULARIO DE CREAR/EDITAR VACANTE:
- Nueva secci√≥n naranja: "‚è± Duraci√≥n y nivel de urgencia"
- Slider interactivo 7-30 d√≠as.
- Nivel de urgencia din√°mico (Alta/Media/Baja) seg√∫n slider.
- Fecha de expiraci√≥n calculada en tiempo real.
- Tip sobre vacantes urgentes.

DASHBOARD DEL RECLUTADOR (/recruiter/jobs):
- Badge de estado de vigencia en cada vacante:
  - "üî¥ Expirada" ‚Üí fondo rojo
  - "‚ö†Ô∏è Por expirar" ‚Üí fondo naranja
  - "üìÖ X d√≠as restantes" ‚Üí fondo azul
- Mensajes de advertencia para vacantes expiradas/por expirar.
- Claridad visual sobre cu√°nto tiempo queda antes de que expire.

B√öSQUEDA DE VACANTES (/jobs):
- Las vacantes expiradas YA NO aparecen en resultados.
- Los candidatos SOLO ven vacantes vigentes (expires_at >= hoy).
- Vacantes viejas (expires_at = NULL) siguen visibles hasta editarse.

BENEFICIOS:
- Control de ciclo de vida: las vacantes no quedan obsoletas indefinidamente.
- Urgencia visible: vacantes de 7-10 d√≠as destacan (futuro: orden prioritario).
- Avisos proactivos: el reclutador sabe cu√°ndo renovar sus publicaciones.
- Limpieza autom√°tica: vacantes expiradas se ocultan sin intervenci√≥n manual.

================================================================================
11. ARCHIVOS MODIFICADOS (RESUMEN)
================================================================================

BASE DE DATOS:
  ‚úÖ supabase/migrations/20250123000003_add_job_validity_fields.sql (nuevo)

DOMINIO:
  ‚úÖ src/domain/entities/JobPosting.ts (extendido)

APLICACI√ìN:
  ‚úÖ src/application/dto/CreateJobPostingDTO.ts (extendido)
  ‚úÖ src/application/use-cases/recruiter/CreateJobPosting.ts (validaci√≥n + c√°lculo)
  ‚úÖ src/application/use-cases/recruiter/UpdateJobPosting.ts (rec√°lculo condicional)

INFRAESTRUCTURA:
  ‚úÖ src/infrastructure/supabase/SupabaseJobPostingRepository.ts (mapeo + filtro)

PRESENTACI√ìN:
  ‚úÖ src/app/recruiter/jobs/new/page.tsx (secci√≥n vigencia agregada)
  ‚úÖ src/app/recruiter/jobs/[id]/edit/page.tsx (secci√≥n vigencia agregada)
  ‚úÖ src/app/recruiter/jobs/page.tsx (badges de estado + funci√≥n getJobStatus)

TOTAL: 9 archivos modificados/creados

================================================================================
12. NOTAS IMPORTANTES
================================================================================

- NO se modific√≥ nada de Iteraci√≥n 1 (KYC) ni Iteraci√≥n 2 (Seguridad).
- NO se implementaron emails reales todav√≠a (no hay INotificationService).
- NO hay cron jobs para notificaciones autom√°ticas (posible Iteraci√≥n 4).
- Arquitectura hexagonal respetada: l√≥gica de c√°lculo en casos de uso.
- Backward compatible: vacantes viejas funcionan sin expires_at.
- Frontend NO puede manipular expires_at (backend authority).
- Nivel de urgencia es solo visual (NO se guarda en BD como columna).

FUTURAS MEJORAS (NO IMPLEMENTADAS):
- Ordenar vacantes urgentes primero en b√∫squeda.
- Emails autom√°ticos 3 d√≠as antes de expiraci√≥n.
- Cron job diario para marcar expiradas como inactivas.
- Opci√≥n "Renovar por 30 d√≠as m√°s" sin editar toda la vacante.
- Analytics: tasa de conversi√≥n seg√∫n vigencia elegida.

================================================================================
FIN DEL RESUMEN - ITERACI√ìN 3
================================================================================
